using System;
using System.Diagnostics;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Windows.Forms;

namespace MailFolderOutlookAddin.HighDpiSupport
{
    // DpiAwareWindowsForm
    // For any top level winform you create, derive from the DpiWindowsForm class
    // if you are creating Windows Forms with the Dpi Awareness Context set to 
    // DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE or DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2
    //
    // For example, if you Window form class is defined as:
    //    public partial class TopLevelWinForm : Form
    //
    // update to:
    //    public partial class TopLevelWinForm : DpiAwareWindowsForm
    //
    // When showing the form, call SetThreadDpiAwarenessContext() or use a context block to
    // to set the desired Dpi Awareness Context.
    //
    // For example, here is code to show a Windows Form using a context block as Per Monitor Aware v2.
    //
    //    DPIContextBlock context = new DPIContextBlock(DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2);
    //    TopLevelWinForm frm = new TopLevelWinForm();
    //    frm.Show();
    //
    public partial class DpiAwareWindowsForm : Form
    {
        private SizeF m_newDpi = SizeF.Empty;
        private RECT newDisplayRect;
        private SizeF m_oldDpi = SizeF.Empty;
        public SizeF CurrentDpi => m_newDpi;

        public DpiAwareWindowsForm()
        {
            this.HandleCreated += new EventHandler((sender, args) =>
            {
                m_oldDpi = m_newDpi = DPIHelper.GetDpiForWindowSizeF(this.Handle);
            });
        }

        public void OnDpiChangedEvent(RECT newRect, SizeF oldDpi, SizeF newDpi)
        {
            this.SuspendLayout();

            // Resize form
            this.Width = newRect.Width;
            this.Height = newRect.Height;

            // Resize controls and set font sizes
            ScaleAllChildControls(newRect, oldDpi, newDpi);
            this.ResumeLayout(true);
        }


        // Additional changes may be needed for controls that set Anchor or Dock properties 
        protected virtual void ScaleAllChildControls(RECT newRect, SizeF oldDpi, SizeF newDpi)
        {
        }
        //private void ScaleAllChildControls(Control.ControlCollection controls, float oldDpi, float newDpi)
        //{
        //    float scaleFactorChange = newDpi / oldDpi;

        //    foreach (Control control in controls)
        //    {
        //        control.Top = (int)(control.Top * scaleFactorChange);
        //        control.Left = (int)(control.Left * scaleFactorChange);
        //        control.Width = (int)(control.Width * scaleFactorChange);
        //        control.Height = (int)(control.Height * scaleFactorChange);
        //        control.Font = ScaleFont(control.Font, oldDpi, newDpi);
        //    }
        //}

        private Font ScaleFont(Font font, float oldDpi, float newDpi)
        {
            float fontSizePx = 0.0f;
            float fontSizePt = 0.0f;

            fontSizePx = font.SizeInPoints / 72 * oldDpi;
            fontSizePt = fontSizePx * (newDpi / oldDpi) * 72 / oldDpi;

            return new Font(font.Name, fontSizePt, font.Style, GraphicsUnit.Point);
        }

        protected override void WndProc(ref Message m)
        {
            switch ((DPIHelper.WinMessages)m.Msg)
            {
                case DPIHelper.WinMessages.WM_DPICHANGED:
                    // Marshal the value in the lParam into a Rect.
                    this.newDisplayRect = (RECT)Marshal.PtrToStructure(m.LParam, typeof(RECT));

                    // Remember current DPI and calculate current from WParam.
                    // Both X and Y are the same on Windows for Dpi.
                    m_oldDpi = m_newDpi;

                    m_newDpi.Width = (float)(m.WParam.ToInt32() >> 16);
                    m_newDpi.Height = (float)(m.WParam.ToInt32() & 0x0000FFFF);

                    // Dpi should be the same for both width and height on Windows devices.
                    Debug.Assert(m_newDpi.Height == m_newDpi.Width);

                    if (m_oldDpi.Width != m_newDpi.Width)
                    {
                        //OnDpiChangedEvent(newDisplayRect);
                    }
                    base.DefWndProc(ref m);
                    break;
                case DPIHelper.WinMessages.WM_EXITSIZEMOVE:
                    Debug.WriteLine($"DPI changed: {m_oldDpi} -> {m_newDpi}");
                    if (m_oldDpi != m_newDpi)
                    {
                        OnDpiChangedEvent(newDisplayRect, m_oldDpi, m_newDpi);
                        m_oldDpi = m_newDpi;
                    }

                    break;

                default:
                    base.WndProc(ref m);
                    break;
            }
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();
            // 
            // DpiAwareWindowsForm
            // 
            this.AutoScaleDimensions = new System.Drawing.SizeF(120F, 120F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Dpi;
            this.ClientSize = new System.Drawing.Size(282, 253);
            this.Name = "DpiAwareWindowsForm";
            this.ResumeLayout(false);

        }
    }
}